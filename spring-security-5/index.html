<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Spring Security(五)-- 动手实现一个 IP_Login - 徐靖峰|个人博客</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Kirito的技术分享"><meta name="msapplication-TileImage" content="/img/avatar.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Kirito的技术分享"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="在开始这篇文章之前，我们似乎应该思考下为什么需要搞清楚 Spring Security 的内部工作原理？按照第二篇文章中的配置，一个简单的表单认证不就达成了吗？更有甚者，为什么我们不自己写一个表单认证，用过滤器即可完成，大费周章引入 Spring Security，看起来也并没有方便多少。对的，在引入 Spring Security 之前，我们得首先想到，是什么需求让我们引入了 Spring Se"><meta property="og:type" content="blog"><meta property="og:title" content="Spring Security(五)-- 动手实现一个 IP_Login"><meta property="og:url" content="https://www.cnkirito.moe/spring-security-5/"><meta property="og:site_name" content="徐靖峰|个人博客"><meta property="og:description" content="在开始这篇文章之前，我们似乎应该思考下为什么需要搞清楚 Spring Security 的内部工作原理？按照第二篇文章中的配置，一个简单的表单认证不就达成了吗？更有甚者，为什么我们不自己写一个表单认证，用过滤器即可完成，大费周章引入 Spring Security，看起来也并没有方便多少。对的，在引入 Spring Security 之前，我们得首先想到，是什么需求让我们引入了 Spring Se"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://image.cnkirito.cn/2011121410543010.jpg"><meta property="og:image" content="https://image.cnkirito.cn/QQ%E5%9B%BE%E7%89%8720171002144410.png"><meta property="og:image" content="https://image.cnkirito.cn/QQ%E5%9B%BE%E7%89%8720171002144520.png"><meta property="og:image" content="https://image.cnkirito.cn/QQ%E5%9B%BE%E7%89%8720171002144800.png"><meta property="og:image" content="https://image.cnkirito.cn/QQ%E5%9B%BE%E7%89%8720171002144949.png"><meta property="og:image" content="https://image.cnkirito.cn/QQ%E5%9B%BE%E7%89%8720171002145344.png"><meta property="og:image" content="https://image.cnkirito.cn/QQ%E5%9B%BE%E7%89%8720171002145209.png"><meta property="og:image" content="https://image.cnkirito.cn/qrcode_for_gh_c06057be7960_258%20%281%29.jpg"><meta property="article:published_time" content="2017-10-01T22:44:34.000Z"><meta property="article:modified_time" content="2025-07-01T03:18:09.739Z"><meta property="article:author" content="徐靖峰"><meta property="article:tag" content="Spring Security"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://image.cnkirito.cn/2011121410543010.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.cnkirito.moe/spring-security-5/"},"headline":"Spring Security(五)-- 动手实现一个 IP_Login","image":["https://image.cnkirito.cn/2011121410543010.jpg","https://image.cnkirito.cn/QQ%E5%9B%BE%E7%89%8720171002144410.png","https://image.cnkirito.cn/QQ%E5%9B%BE%E7%89%8720171002144520.png","https://image.cnkirito.cn/QQ%E5%9B%BE%E7%89%8720171002144800.png","https://image.cnkirito.cn/QQ%E5%9B%BE%E7%89%8720171002144949.png","https://image.cnkirito.cn/QQ%E5%9B%BE%E7%89%8720171002145344.png","https://image.cnkirito.cn/QQ%E5%9B%BE%E7%89%8720171002145209.png","https://image.cnkirito.cn/qrcode_for_gh_c06057be7960_258%20%281%29.jpg"],"datePublished":"2017-10-01T22:44:34.000Z","dateModified":"2025-07-01T03:18:09.739Z","author":{"@type":"Person","name":"徐靖峰"},"description":"在开始这篇文章之前，我们似乎应该思考下为什么需要搞清楚 Spring Security 的内部工作原理？按照第二篇文章中的配置，一个简单的表单认证不就达成了吗？更有甚者，为什么我们不自己写一个表单认证，用过滤器即可完成，大费周章引入 Spring Security，看起来也并没有方便多少。对的，在引入 Spring Security 之前，我们得首先想到，是什么需求让我们引入了 Spring Se"}</script><link rel="canonical" href="https://www.cnkirito.moe/spring-security-5/"><link rel="icon" href="/img/avatar.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-118574570-1" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'UA-118574570-1');</script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/avatar.png" alt="徐靖峰|个人博客" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/.">主页</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/about">关于</a><a class="navbar-item" target="_blank" rel="noopener" href="https://github.com/YunaiV/onemall">开源项目</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" id="article-content" role="article"><h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal"><i class="fas fa-angle-double-right"></i>Spring Security(五)-- 动手实现一个 IP_Login</h1><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><i class="far fa-calendar-alt"> </i><time dateTime="${date_xml(page.date)}" title="${date_xml(page.date)}">2017-10-01</time></span><span class="level-item is-hidden-mobile"><i class="far fa-calendar-check"> </i><time dateTime="${date_xml(page.updated)}" title="${date_xml(page.updated)}">2025-07-01</time></span><span class="level-item"><a class="link-muted" href="/categories/Spring-Security/">Spring Security</a></span><span class="level-item">15 分钟读完 (大约2295个字)</span></div></div><div class="content"><p>在开始这篇文章之前，我们似乎应该思考下为什么需要搞清楚 Spring Security 的内部工作原理？按照第二篇文章中的配置，一个简单的表单认证不就达成了吗？更有甚者，为什么我们不自己写一个表单认证，用过滤器即可完成，大费周章引入 Spring Security，看起来也并没有方便多少。对的，在引入 Spring Security 之前，我们得首先想到，是什么需求让我们引入了 Spring Security，以及为什么是 Spring Security，而不是 shiro 等等其他安全框架。我的理解是有如下几点：</p>
<p>1 在前文的介绍中，Spring Security 支持防止 csrf 攻击，session-fixation protection，支持表单认证，basic 认证，rememberMe… 等等一些特性，有很多是开箱即用的功能，而大多特性都可以通过配置灵活的变更，这是它的强大之处。</p>
<p>2 Spring Security 的兄弟的项目 Spring Security SSO，OAuth2 等支持了多种协议，而这些都是基于 Spring Security 的，方便了项目的扩展。</p>
<p>3 SpringBoot 的支持，更加保证了 Spring Security 的开箱即用。</p>
<p>4 为什么需要理解其内部工作原理? 一个有自我追求的程序员都不会满足于浅尝辄止，如果一个开源技术在我们的日常工作中十分常用，那么我偏向于阅读其源码，这样可以让我们即使排查不期而至的问题，也方便日后需求扩展。</p>
<p>5 Spring 及其子项目的官方文档是我见过的最良心的文档！~~ 相比较于 Apache 的部分文档 ~~</p>
<p>这一节，为了对之前分析的 Spring Security 源码和组件有一个清晰的认识，介绍一个使用 IP 完成登录的简单 demo。</p>
<span id="more"></span>

<h2 id="5-动手实现一个-IP-Login"><a href="#5-动手实现一个-IP-Login" class="headerlink" title="5 动手实现一个 IP_Login"></a>5 动手实现一个 IP_Login</h2><h3 id="5-1-定义需求"><a href="#5-1-定义需求" class="headerlink" title="5.1 定义需求"></a>5.1 定义需求</h3><p>在表单登录中，一般使用数据库中配置的用户表，权限表，角色表，权限组表… 这取决于你的权限粒度，但本质都是借助了一个持久化存储，维护了用户的角色权限，而后给出一个 /login 作为登录端点，使用表单提交用户名和密码，而后完成登录后可自由访问受限页面。</p>
<p>在我们的 IP 登录 demo 中，也是类似的，使用 IP 地址作为身份，内存中的一个 ConcurrentHashMap 维护 IP 地址和权限的映射，如果在认证时找不到相应的权限，则认为认证失败。</p>
<p>实际上，在表单登录中，用户的 IP 地址已经被存放在 Authentication.getDetails() 中了，完全可以只重写一个 AuthenticationProvider 认证这个 IP 地址即可，但是，本 demo 是为了厘清 Spring Security 内部工作原理而设置，为了设计到更多的类，我完全重写了 IP 过滤器。</p>
<h3 id="5-2-设计概述"><a href="#5-2-设计概述" class="headerlink" title="5.2 设计概述"></a>5.2 设计概述</h3><p>我们的参考完全是表单认证，在之前章节中，已经了解了表单认证相关的核心流程，将此图再贴一遍：</p>
<p><img src="https://image.cnkirito.cn/2011121410543010.jpg" alt="https://image.cnkirito.cn/2011121410543010.jpg"></p>
<p>在 IP 登录的 demo 中，使用 IpAuthenticationProcessingFilter 拦截 IP 登录请求，同样使用 ProviderManager 作为全局 AuthenticationManager 接口的实现类，将 ProviderManager 内部的 DaoAuthenticationProvider 替换为 IpAuthenticationProvider，而 UserDetailsService 则使用一个 ConcurrentHashMap 代替。更详细一点的设计：</p>
<ol>
<li>IpAuthenticationProcessingFilter–&gt;UsernamePasswordAuthenticationFilter</li>
<li>IpAuthenticationToken–&gt;UsernamePasswordAuthenticationToken</li>
<li>ProviderManager–&gt;ProviderManager</li>
<li>IpAuthenticationProvider–&gt;DaoAuthenticationProvider</li>
<li>ConcurrentHashMap–&gt;UserDetailsService</li>
</ol>
<h3 id="5-3-IpAuthenticationToken"><a href="#5-3-IpAuthenticationToken" class="headerlink" title="5.3 IpAuthenticationToken"></a>5.3 IpAuthenticationToken</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IpAuthenticationToken</span> <span class="keyword">extends</span> <span class="title">AbstractAuthenticationToken</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String ip;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getIp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ip;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIp</span><span class="params">(String ip)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.ip = ip;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">IpAuthenticationToken</span><span class="params">(String ip)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">this</span>.ip = ip;</span><br><span class="line">        <span class="keyword">super</span>.setAuthenticated(<span class="keyword">false</span>);<span class="comment">// 注意这个构造方法是认证时使用的</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">IpAuthenticationToken</span><span class="params">(String ip, Collection&lt;? extends GrantedAuthority&gt; authorities)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(authorities);</span><br><span class="line">        <span class="keyword">this</span>.ip = ip;</span><br><span class="line">        <span class="keyword">super</span>.setAuthenticated(<span class="keyword">true</span>);<span class="comment">// 注意这个构造方法是认证成功后使用的</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getCredentials</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getPrincipal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.ip;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>两个构造方法需要引起我们的注意，这里设计的用意是模仿的 UsernamePasswordAuthenticationToken，第一个构造器是用于认证之前，传递给认证器使用的，所以只有 IP 地址，自然是未认证；第二个构造器用于认证成功之后，封装认证用户的信息，此时需要将权限也设置到其中，并且 setAuthenticated(true)。这样的设计在诸多的 Token 类设计中很常见。</p>
<h3 id="5-4-IpAuthenticationProcessingFilter"><a href="#5-4-IpAuthenticationProcessingFilter" class="headerlink" title="5.4 IpAuthenticationProcessingFilter"></a>5.4 IpAuthenticationProcessingFilter</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IpAuthenticationProcessingFilter</span> <span class="keyword">extends</span> <span class="title">AbstractAuthenticationProcessingFilter</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 使用 /ipVerify 该端点进行 ip 认证</span></span><br><span class="line">    IpAuthenticationProcessingFilter() &#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="keyword">new</span> AntPathRequestMatcher(<span class="string">&quot;/ipVerify&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Authentication <span class="title">attemptAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> AuthenticationException, IOException, ServletException </span>&#123;</span><br><span class="line">        <span class="comment">// 获取 host 信息</span></span><br><span class="line">        String host = request.getRemoteHost();</span><br><span class="line">        <span class="comment">// 交给内部的 AuthenticationManager 去认证，实现解耦</span></span><br><span class="line">        <span class="keyword">return</span> getAuthenticationManager().authenticate(<span class="keyword">new</span> IpAuthenticationToken(host));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>AbstractAuthenticationProcessingFilter 这个过滤器在前面一节介绍过，是 UsernamePasswordAuthenticationFilter 的父类，我们的 IpAuthenticationProcessingFilter 也继承了它</li>
<li>构造器中传入了 /ipVerify 作为 IP 登录的端点</li>
<li>attemptAuthentication() 方法中加载请求的 IP 地址，之后交给内部的 AuthenticationManager 去认证</li>
</ol>
<h3 id="5-5-IpAuthenticationProvider"><a href="#5-5-IpAuthenticationProvider" class="headerlink" title="5.5 IpAuthenticationProvider"></a>5.5 IpAuthenticationProvider</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IpAuthenticationProvider</span> <span class="keyword">implements</span> <span class="title">AuthenticationProvider</span> </span>&#123;</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">static</span> Map&lt;String, SimpleGrantedAuthority&gt; ipAuthorityMap = <span class="keyword">new</span> ConcurrenHashMap();</span><br><span class="line">    <span class="comment">// 维护一个 ip 白名单列表，每个 ip 对应一定的权限</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        ipAuthorityMap.put(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="keyword">new</span> SimpleGrantedAuthority(<span class="string">&quot;ADMIN&quot;</span>));</span><br><span class="line">        ipAuthorityMap.put(<span class="string">&quot;10.236.69.103&quot;</span>, <span class="keyword">new</span> SimpleGrantedAuthority(<span class="string">&quot;ADMIN&quot;</span>));</span><br><span class="line">        ipAuthorityMap.put(<span class="string">&quot;10.236.69.104&quot;</span>, <span class="keyword">new</span> SimpleGrantedAuthority(<span class="string">&quot;FRIEND&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        IpAuthenticationToken ipAuthenticationToken = (IpAuthenticationToken) authentication;</span><br><span class="line">        String ip = ipAuthenticationToken.getIp();</span><br><span class="line">        SimpleGrantedAuthority simpleGrantedAuthority = ipAuthorityMap.get(ip);</span><br><span class="line">        <span class="comment">// 不在白名单列表中</span></span><br><span class="line">        <span class="keyword">if</span> (simpleGrantedAuthority == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 封装权限信息，并且此时身份已经被认证</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> IpAuthenticationToken(ip, Arrays.asList(simpleGrantedAuthority));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 只支持 IpAuthenticationToken 该身份</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; authentication)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (IpAuthenticationToken.class</span><br><span class="line">                .isAssignableFrom(authentication));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>return new IpAuthenticationToken(ip, Arrays.asList(simpleGrantedAuthority));</code> 使用了 IpAuthenticationToken 的第二个构造器，返回了一个已经经过认证的 IpAuthenticationToken。</p>
<h3 id="5-6-配置-WebSecurityConfigAdapter"><a href="#5-6-配置-WebSecurityConfigAdapter" class="headerlink" title="5.6 配置 WebSecurityConfigAdapter"></a>5.6 配置 WebSecurityConfigAdapter</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ip 认证者配置</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">IpAuthenticationProvider <span class="title">ipAuthenticationProvider</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> IpAuthenticationProvider();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置封装 ipAuthenticationToken 的过滤器</span></span><br><span class="line">    <span class="function">IpAuthenticationProcessingFilter <span class="title">ipAuthenticationProcessingFilter</span><span class="params">(AuthenticationManager authenticationManager)</span> </span>&#123;</span><br><span class="line">        IpAuthenticationProcessingFilter ipAuthenticationProcessingFilter = <span class="keyword">new</span> IpAuthenticationProcessingFilter();</span><br><span class="line">        <span class="comment">// 为过滤器添加认证器</span></span><br><span class="line">        ipAuthenticationProcessingFilter.setAuthenticationManager(authenticationManager);</span><br><span class="line">        <span class="comment">// 重写认证失败时的跳转页面</span></span><br><span class="line">        ipAuthenticationProcessingFilter.setAuthenticationFailureHandler(<span class="keyword">new</span> SimpleUrlAuthenticationFailureHandler(<span class="string">&quot;/ipLogin?error&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> ipAuthenticationProcessingFilter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置登录端点</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">LoginUrlAuthenticationEntryPoint <span class="title">loginUrlAuthenticationEntryPoint</span><span class="params">()</span></span>&#123;</span><br><span class="line">        LoginUrlAuthenticationEntryPoint loginUrlAuthenticationEntryPoint = <span class="keyword">new</span> LoginUrlAuthenticationEntryPoint</span><br><span class="line">                (<span class="string">&quot;/ipLogin&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> loginUrlAuthenticationEntryPoint;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http</span><br><span class="line">            .authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;/home&quot;</span>).permitAll()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/ipLogin&quot;</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">            .logout()</span><br><span class="line">                .logoutSuccessUrl(<span class="string">&quot;/&quot;</span>)</span><br><span class="line">                .permitAll()</span><br><span class="line">                .and()</span><br><span class="line">            .exceptionHandling()</span><br><span class="line">                .accessDeniedPage(<span class="string">&quot;/ipLogin&quot;</span>)</span><br><span class="line">                .authenticationEntryPoint(loginUrlAuthenticationEntryPoint())</span><br><span class="line">        ;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注册 IpAuthenticationProcessingFilter  注意放置的顺序 这很关键</span></span><br><span class="line">        http.addFilterBefore(ipAuthenticationProcessingFilter(authenticationManager()), UsernamePasswordAuthenticationFilter.class);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        auth.authenticationProvider(ipAuthenticationProvider());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>WebSecurityConfigAdapter 提供了我们很大的便利，不需要关注 AuthenticationManager 什么时候被创建，只需要使用其暴露的 <code>configure(AuthenticationManagerBuilder auth)</code> 便可以添加我们自定义的 ipAuthenticationProvider。剩下的一些细节，注释中基本都写了出来。</p>
<h3 id="5-7-配置-SpringMVC"><a href="#5-7-配置-SpringMVC" class="headerlink" title="5.7 配置 SpringMVC"></a>5.7 配置 SpringMVC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MvcConfig</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addViewControllers</span><span class="params">(ViewControllerRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addViewController(<span class="string">&quot;/home&quot;</span>).setViewName(<span class="string">&quot;home&quot;</span>);</span><br><span class="line">        registry.addViewController(<span class="string">&quot;/&quot;</span>).setViewName(<span class="string">&quot;home&quot;</span>);</span><br><span class="line">        registry.addViewController(<span class="string">&quot;/hello&quot;</span>).setViewName(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        registry.addViewController(<span class="string">&quot;/ip&quot;</span>).setViewName(<span class="string">&quot;ipHello&quot;</span>);</span><br><span class="line">        registry.addViewController(<span class="string">&quot;/ipLogin&quot;</span>).setViewName(<span class="string">&quot;ipLogin&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>页面的具体内容和表单登录基本一致，可以在文末的源码中查看。</p>
<h3 id="5-8-运行效果"><a href="#5-8-运行效果" class="headerlink" title="5.8 运行效果"></a>5.8 运行效果</h3><h3 id="成功的流程"><a href="#成功的流程" class="headerlink" title="成功的流程"></a>成功的流程</h3><ul>
<li><code>http://127.0.0.1:8080/</code> 访问首页，其中 here 链接到的地址为：<code>http://127.0.0.1:8080/hello</code></li>
</ul>
<p><img src="https://image.cnkirito.cn/QQ%E5%9B%BE%E7%89%8720171002144410.png" alt="首页"></p>
<ul>
<li>点击 here，由于 <code>http://127.0.0.1:8080/hello</code> 是受保护资源，所以跳转到了校验 IP 的页面。此时若点击 Sign In by IP 按钮，将会提交到 /ipVerify 端点，进行 IP 的认证。</li>
</ul>
<p><img src="https://image.cnkirito.cn/QQ%E5%9B%BE%E7%89%8720171002144520.png" alt="登录"></p>
<ul>
<li>登录校验成功之后，页面被成功重定向到了原先访问的</li>
</ul>
<p><img src="https://image.cnkirito.cn/QQ%E5%9B%BE%E7%89%8720171002144800.png" alt="受保护的 hello 页"></p>
<h3 id="失败的流程"><a href="#失败的流程" class="headerlink" title="失败的流程"></a>失败的流程</h3><ul>
<li>注意此时已经注销了上次的登录，并且，使用了 localhost(localhost 和 127.0.0.1 是两个不同的 IP 地址，我们的内存中只有 127.0.0.1 的用户, 没有 localhost 的用户)</li>
</ul>
<p><img src="https://image.cnkirito.cn/QQ%E5%9B%BE%E7%89%8720171002144949.png" alt="首页"></p>
<ul>
<li><p>点击 here 后，由于没有认证过，依旧跳转到登录页面</p>
<p><img src="https://image.cnkirito.cn/QQ%E5%9B%BE%E7%89%8720171002145344.png" alt="登录"></p>
</li>
<li><p>此时，我们发现使用 localhost，并没有认证成功，符合我们的预期</p>
</li>
</ul>
<p><img src="https://image.cnkirito.cn/QQ%E5%9B%BE%E7%89%8720171002145209.png" alt="认证失败"></p>
<h3 id="5-9-总结"><a href="#5-9-总结" class="headerlink" title="5.9 总结"></a>5.9 总结</h3><p>一个简单的使用 Spring Security 来进行验证 IP 地址的登录 demo 就已经完成了，这个 demo 主要是为了更加清晰地阐释 Spring Security 内部工作的原理设置的，其本身没有实际的项目意义，认证 IP 其实也不应该通过 Spring Security 的过滤器去做，退一步也应该交给 Filter 去做（这个 Filter 不存在于 Spring Security 的过滤器链中），而真正项目中，如果真正要做黑白名单这样的功能，一般选择在网关层或者 nginx 的扩展模块中做。再次特地强调下，怕大家误解。</p>
<p>最后祝大家国庆玩的开心 ~</p>
<p>本节的代码可以在 github 中下载源码：<a target="_blank" rel="noopener" href="https://github.com/lexburner/spring-security-ipLogin">https://github.com/lexburner/spring-security-ipLogin</a></p>
<p>** 欢迎关注我的微信公众号：「Kirito 的技术分享」，关于文章的任何疑问都会得到回复，带来更多 Java 相关的技术分享。**</p>
<p><img src="https://image.cnkirito.cn/qrcode_for_gh_c06057be7960_258%20%281%29.jpg" alt="关注微信公众号"></p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Spring Security(五)-- 动手实现一个 IP_Login</p><p><a href="https://www.cnkirito.moe/spring-security-5/">https://www.cnkirito.moe/spring-security-5/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>徐靖峰</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2017-10-01</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2025-07-01</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><hr style="height:1px;margin:1rem 0"><div class="level is-mobile is-flex"><div class="article-tags is-size-7 is-uppercase"><i class="fas fa-tags has-text-grey"></i> <a class="link-muted" rel="tag" href="/tags/Spring-Security/">Spring Security </a></div></div><!--!--></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/alipay.png" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/wechatpay.png" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/concurrent-1/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">浅析项目中的并发 (一)</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/spring-security-4/"><span class="level-item">Spring Security(四)-- 核心过滤器源码分析</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--><div><script src="https://readmore.openwrite.cn/js/readmore.js" type="text/javascript"></script>
            <script>
                const btw = new BTWPlugin();
                btw.init({
                    id: "article-content",
                    blogId: '10053-1610820399501-222',
                    name: 'Kirito的技术分享',
                    qrcode: 'http://image.cnkirito.cn/qrcode_for_gh_c06057be7960_258%20%281%29.jpg',
                    keyword: 'more'
                });
                var rm_btn = $('#read-more-btn');
                rm_btn.html('~阅读全文~人机检测~');
            </script>
            </div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="徐靖峰"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">徐靖峰</p><p class="is-size-6 is-block">阿里巴巴中间件研发</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国·杭州</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">177</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">22</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">77</p></a></div></div></nav><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/wechat_public.jpg" alt="Kirito的技术分享"></figure><div class="level"><a class="level-item button is-primary is-rounded" target="_blank" rel="noopener">↑关注微信公众号↑</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/lexburner"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="WeChat" href="/img/wechat_public.jpg"><i class="fab fa-weixin"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#5-动手实现一个-IP-Login"><span class="level-left"><span class="level-item">1</span><span class="level-item">5 动手实现一个 IP_Login</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#5-1-定义需求"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">5.1 定义需求</span></span></a></li><li><a class="level is-mobile" href="#5-2-设计概述"><span class="level-left"><span class="level-item">1.2</span><span class="level-item">5.2 设计概述</span></span></a></li><li><a class="level is-mobile" href="#5-3-IpAuthenticationToken"><span class="level-left"><span class="level-item">1.3</span><span class="level-item">5.3 IpAuthenticationToken</span></span></a></li><li><a class="level is-mobile" href="#5-4-IpAuthenticationProcessingFilter"><span class="level-left"><span class="level-item">1.4</span><span class="level-item">5.4 IpAuthenticationProcessingFilter</span></span></a></li><li><a class="level is-mobile" href="#5-5-IpAuthenticationProvider"><span class="level-left"><span class="level-item">1.5</span><span class="level-item">5.5 IpAuthenticationProvider</span></span></a></li><li><a class="level is-mobile" href="#5-6-配置-WebSecurityConfigAdapter"><span class="level-left"><span class="level-item">1.6</span><span class="level-item">5.6 配置 WebSecurityConfigAdapter</span></span></a></li><li><a class="level is-mobile" href="#5-7-配置-SpringMVC"><span class="level-left"><span class="level-item">1.7</span><span class="level-item">5.7 配置 SpringMVC</span></span></a></li><li><a class="level is-mobile" href="#5-8-运行效果"><span class="level-left"><span class="level-item">1.8</span><span class="level-item">5.8 运行效果</span></span></a></li><li><a class="level is-mobile" href="#成功的流程"><span class="level-left"><span class="level-item">1.9</span><span class="level-item">成功的流程</span></span></a></li><li><a class="level is-mobile" href="#失败的流程"><span class="level-left"><span class="level-item">1.10</span><span class="level-item">失败的流程</span></span></a></li><li><a class="level is-mobile" href="#5-9-总结"><span class="level-left"><span class="level-item">1.11</span><span class="level-item">5.9 总结</span></span></a></li></ul></li></ul></div></div><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/avatar.png" alt="徐靖峰|个人博客" height="28"></a><p class="is-size-7"><span>&copy; 2025 徐靖峰</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>